server:
  port: 8080

spring:
  application:
    name: api-gateway

  cloud:
    gateway:
      default-filters:
        - PreserveHostHeader

      discovery:
        locator:
          enabled: true
          lower-case-service-id: true

      routes:
        # ===== AUTH SERVICE ROUTES =====
        # Public routes (no auth needed)
        - id: auth-login-public
          uri: lb://auth-service
          predicates:
            - Path=/auth/login,/auth/register
          filters:
            - RewritePath=/auth/(?<segment>.*), /api/auth/${segment}

        # Protected auth routes
        - id: auth-service
          uri: lb://auth-service
          predicates:
            - Path=/auth/**
          filters:
            - RewritePath=/auth/(?<segment>.*), /api/auth/${segment}

        # User management routes
        - id: users-service
          uri: lb://auth-service
          predicates:
            - Path=/users,/users/**
          filters:
            - RewritePath=/users(?<segment>/.*)?$, /api/users${segment}

        # Admin routes
        - id: admin-service
          uri: lb://auth-service
          predicates:
            - Path=/admin,/admin/**
          filters:
            - RewritePath=/admin(?<segment>/.*)?$, /api/admin${segment}

        # ===== UNIVERSITY SERVICE ROUTES =====
        - id: university-service
          uri: lb://university-service
          predicates:
            - Path=/universities,/universities/**
          filters:
            - RewritePath=/universities(?<segment>/.*)?$, /api/universities${segment}

        # ===== CERTIFICATE SERVICE ROUTES =====
        - id: certificate-service
          uri: lb://certificate-service
          predicates:
            - Path=/certificates,/certificates/**
          filters:
            - RewritePath=/certificates(?<segment>/.*)?$, /api/certificates${segment}

        # ===== VERIFICATION SERVICE ROUTES =====
        # Health check route (specific)
        - id: verification-health
          uri: lb://verification-service
          predicates:
            - Path=/verify/health
          filters:
            - RewritePath=/verify/health, /api/health

        # Verify by ID (GET /verify/{id})
        - id: verification-by-id
          uri: lb://verification-service
          predicates:
            - Path=/verify/{id}
            - Method=GET
          filters:
            - RewritePath=/verify/(?<id>[^/]+), /api/verify/${id}

        # Verify with payload (POST /verify)
        - id: verification-post
          uri: lb://verification-service
          predicates:
            - Path=/verify
            - Method=POST
          filters:
            - RewritePath=/verify, /api/verify

        # Bulk verification (POST /verify/bulk)
        - id: verification-bulk
          uri: lb://verification-service
          predicates:
            - Path=/verify/bulk
            - Method=POST
          filters:
            - RewritePath=/verify/bulk, /api/verify/bulk

        # Catch-all for other verify endpoints
        - id: verification-service
          uri: lb://verification-service
          predicates:
            - Path=/verify/**
          filters:
            - RewritePath=/verify(?<segment>/.*)?$, /api/verify${segment}

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka
    fetch-registry: true
    register-with-eureka: true

# Enable actuator endpoints for debugging
management:
  endpoints:
    web:
      exposure:
        include: "*"
      base-path: /actuator
  endpoint:
    gateway:
      enabled: true
    health:
      show-details: always

# Logging for debugging (remove in production)
logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    reactor.netty.http.client: DEBUG
    org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping: TRACE